<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ü‡∏ô‡∏™‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏±‡∏Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&family=Prompt:wght@500;700&display=swap');
    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #a7bfff 0%, #f7f7fb 100%);
      margin: 0;
      min-height: 100vh;
      letter-spacing: 0.01em;
    }
    .chat-container {
      max-width: 700px;
      margin: 32px auto;
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 8px 32px #0002, 0 2px 8px #2563eb22;
      display: flex;
      flex-direction: column;
      height: 88vh;
      overflow: hidden;
      border: 2.5px solid #a7bfff;
      position: relative;
      transition: box-shadow 0.2s;
    }
    .chat-container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: 22px;
      box-shadow: 0 0 0 4px #fff3, 0 0 0 8px #a7bfff22;
      z-index: 0;
    }
    .top-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 18px 24px 0 24px;
      background: linear-gradient(90deg, #f1f5ff 60%, #f7f7fb 100%);
      border-radius: 22px 22px 0 0;
      min-height: 56px;
      box-shadow: 0 2px 8px #2563eb0a;
      position: relative;
      z-index: 1;
    }
    .history-btn, .fav-btn {
      background: #fff;
      color: #2563eb;
      border: 2px solid #a7bfff;
      border-radius: 10px;
      padding: 7px 16px;
      cursor: pointer;
      font-size: 1.01rem;
      font-weight: 600;
      transition: background 0.18s, color 0.18s, border 0.18s;
      outline: none;
      box-shadow: 0 1px 4px #2563eb11;
      letter-spacing: 0.01em;
    }
    .history-btn:hover, .fav-btn:hover {
      background: #a7bfff;
      color: #fff;
      border: 2px solid #2563eb;
    }
    .history-btn:active, .fav-btn:active {
      background: #2563eb;
      color: #fff;
      border: 2px solid #2563eb;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 32px 32px 18px 32px;
      background: linear-gradient(135deg, #f7f7fb 80%, #a7bfff 100%);
      scroll-behavior: smooth;
      z-index: 1;
    }
    .message {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .user {
      align-items: flex-end;
    }
    .ai {
      align-items: flex-start;
    }
    .bubble {
      display: inline-block;
      padding: 13px 18px;
      border-radius: 18px;
      max-width: 90%;
      font-size: 1.08rem;
      box-shadow: 0 1px 6px #2563eb0a;
      word-break: break-word;
      position: relative;
      transition: background 0.2s;
      font-family: 'Prompt', 'Sarabun', sans-serif;
      line-height: 1.7;
    }
    .user .bubble {
      background: linear-gradient(90deg, #a7bfff 80%, #f0f9ff 100%);
      color: #222;
      border-bottom-right-radius: 4px;
      border-top-right-radius: 18px;
      border-top-left-radius: 18px;
      border-bottom-left-radius: 18px;
      align-self: flex-end;
      margin-left: 40px;
      border: 1.5px solid #a7bfff;
    }
    .ai .bubble {
      background: linear-gradient(90deg, #f1f5f9 80%, #e0e7ff 100%);
      color: #222;
      border-bottom-left-radius: 4px;
      border-top-right-radius: 18px;
      border-top-left-radius: 18px;
      border-bottom-right-radius: 18px;
      align-self: flex-start;
      margin-right: 40px;
      border: 1.5px solid #e0e7ff;
    }
    .step {
      margin: 7px 0;
      font-size: 1.04em;
      line-height: 1.8;
      font-family: 'Sarabun', sans-serif;
      color: #374151;
    }
    .input-area {
      display: flex;
      border-top: 2px solid #a7bfff;
      padding: 18px 18px 18px 18px;
      background: #f7f7fb;
      border-radius: 0 0 22px 22px;
      gap: 10px;
      box-shadow: 0 -2px 8px #2563eb0a;
      z-index: 1;
    }
    .input-area input {
      flex: 1;
      padding: 13px 18px;
      border-radius: 12px;
      border: 2px solid #a7bfff;
      font-size: 1.09rem;
      background: #fff;
      transition: border 0.2s, box-shadow 0.2s;
      outline: none;
      box-shadow: 0 1px 4px #2563eb11;
      font-family: 'Prompt', 'Sarabun', sans-serif;
    }
    .input-area input:focus {
      border: 2px solid #2563eb;
      box-shadow: 0 2px 8px #2563eb22;
    }
    .input-area button {
      padding: 13px 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(90deg, #2563eb 80%, #60a5fa 100%);
      color: #fff;
      font-size: 1.09rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px #2563eb22;
      outline: none;
      letter-spacing: 0.01em;
    }
    .input-area button:hover {
      background: linear-gradient(90deg, #1d4ed8 80%, #60a5fa 100%);
    }
    .input-area button:active {
      background: #1d4ed8;
    }
    .quiz-btn {
      margin: 0 0 12px 0;
      background: linear-gradient(90deg, #f59e42 80%, #fbbf24 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1.04rem;
      font-weight: 700;
      box-shadow: 0 1px 4px #f59e4211;
      transition: background 0.2s;
      letter-spacing: 0.01em;
      margin-left: 2px;
    }
    .quiz-btn:hover {
      background: linear-gradient(90deg, #ea580c 80%, #fbbf24 100%);
    }
    .quiz-btn:active {
      background: #ea580c;
    }
    .fav-star {
      color: #f59e42;
      margin-left: 8px;
      cursor: pointer;
      font-size: 1.18em;
      vertical-align: middle;
      transition: color 0.2s;
    }
    .fav-star.filled {
      color: #ea580c;
      text-shadow: 0 1px 4px #f59e4211;
    }
    .modal-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #0006; display: flex; align-items: center; justify-content: center; z-index: 1000;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal {
      background: #fff;
      border-radius: 18px;
      padding: 32px 24px 24px 24px;
      min-width: 320px;
      max-width: 98vw;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 4px 24px #2563eb22, 0 1.5px 6px #2563eb11;
      animation: popIn 0.2s;
      font-family: 'Prompt', 'Sarabun', sans-serif;
    }
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0.7; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal h3 {
      margin-top: 0;
      font-weight: 700;
      color: #2563eb;
      letter-spacing: 0.5px;
      font-size: 1.18em;
    }
    .modal .close-btn {
      float: right;
      background: none;
      border: none;
      font-size: 1.3rem;
      color: #888;
      cursor: pointer;
      margin-top: -8px;
      margin-right: -8px;
      transition: color 0.2s;
    }
    .modal .close-btn:hover {
      color: #2563eb;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      background: #f1f5ff;
    }
    ::-webkit-scrollbar-thumb {
      background: #a7bfff;
      border-radius: 6px;
    }
    ::selection {
      background: #a7bfff;
      color: #fff;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .chat-container { max-width: 99vw; }
      .chat-messages { padding: 18px 4vw 12px 4vw; }
    }
    @media (max-width: 700px) {
      .chat-container { max-width: 100vw; margin: 0; border-radius: 0; }
      .top-bar, .input-area { border-radius: 0; }
      .modal { min-width: 90vw; }
      .chat-messages { padding: 18px 4vw 12px 4vw; }
    }
    /* Youthful touch */
    .bubble, .quiz-btn, .history-btn, .fav-btn, #xp-indicator {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      letter-spacing: 0.01em;
    }
    .bubble code, .step code {
      background: #f1f5ff;
      color: #2563eb;
      border-radius: 5px;
      padding: 2px 6px;
      font-size: 0.98em;
      font-family: 'Fira Mono', 'Consolas', monospace;
    }
  </style>
  <!-- MathJax CDN -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <button class="history-btn" id="history-btn">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°</button>
      <button class="fav-btn" id="fav-btn">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡∏î</button>
      <!-- ‡∏•‡∏ö XP indicator -->
    </div>
    <div class="chat-messages" id="chat">
      <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    </div>
    <div class="input-area">
      <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô '‡∏à‡∏á‡πÅ‡∏Å‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£ x¬≤ + 3x = 0' ‡∏´‡∏£‡∏∑‡∏≠ '‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Assume'..." autocomplete="off" />
      <button id="send-btn">‡∏™‡πà‡∏á</button>
    </div>
  </div>
  <div id="modal-bg" style="display:none"></div>
  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const historyBtn = document.getElementById('history-btn');
    const favBtn = document.getElementById('fav-btn');
    const modalBg = document.getElementById('modal-bg');

    // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡∏î
    let history = JSON.parse(localStorage.getItem('ai_tutor_history') || '[]');
    let favorites = JSON.parse(localStorage.getItem('ai_tutor_favorites') || '[]');

    function saveHistory() {
      localStorage.setItem('ai_tutor_history', JSON.stringify(history));
    }
    function saveFavorites() {
      localStorage.setItem('ai_tutor_favorites', JSON.stringify(favorites));
    }

    // Modal ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡πÇ‡∏õ‡∏£‡∏î
    function showModal(title, items, onSelect) {
      modalBg.innerHTML = `
        <div class="modal">
          <button class="close-btn" onclick="document.getElementById('modal-bg').style.display='none'">&times;</button>
          <h3>${title}</h3>
          <div>
            ${items.length === 0 ? '<div style="color:#888">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>' : items.map((item, i) => `
              <div style="margin-bottom:10px;">
                <span style="cursor:pointer;color:#2563eb;" onclick="window._modalSelect(${i})">${item.text}</span>
                ${onSelect === 'fav' ? `<span class="fav-star filled" title="‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡∏î" onclick="window._removeFav(${i})">&#9733;</span>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
      modalBg.style.display = 'flex';
    }

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal callback
    window._modalSelect = function(idx) {
      modalBg.style.display = 'none';
      const item = modalBg._items[idx];
      input.value = item.text;
      input.focus();
    };
    window._removeFav = function(idx) {
      favorites.splice(idx, 1);
      saveFavorites();
      showModal('‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡∏î', favorites, 'fav');
    };

    // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    historyBtn.onclick = () => {
      modalBg._items = history;
      showModal('‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°', history, 'history');
    };
    // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏î
    favBtn.onclick = () => {
      modalBg._items = favorites;
      showModal('‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡∏î', favorites, 'fav');
    };

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS: sanitize HTML output
    function sanitizeHTML(str) {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
    function addMessage(role, text, steps, isFav) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (steps && Array.isArray(steps)) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡πÄ‡∏•‡∏Ç/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠) ‡∏û‡∏£‡πâ‡∏≠‡∏° emoji ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏™‡∏±‡∏ô
        const list = document.createElement('ol');
        list.style.margin = '0 0 0 1.2em';
        list.style.padding = '0';
        let hasList = false;
        steps.forEach((step, idx) => {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° emoji ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö
          let coloredStep = step;
          if (step.startsWith('<b>Quiz:')) {
            coloredStep = `<span style="color:#f59e42;font-weight:bold;">üé≤ ${step.replace('<b>Quiz:', 'Quiz:').replace('</b>', '')}</span>`;
          } else if (step.startsWith('<b>Newton')) {
            coloredStep = `<span style="color:#2563eb;font-weight:bold;">üß≤ ${step.replace('<b>', '').replace('</b>', '')}</span>`;
          } else if (step.startsWith('<b>Present Perfect')) {
            coloredStep = `<span style="color:#22c55e;font-weight:bold;">üìö ${step.replace('<b>', '').replace('</b>', '')}</span>`;
          } else if (step.startsWith('<b>Assume')) {
            coloredStep = `<span style="color:#f472b6;font-weight:bold;">üí° ${step.replace('<b>', '').replace('</b>', '')}</span>`;
          } else if (step.startsWith('<b>‡∏ï‡∏≠‡∏ö:')) {
            coloredStep = `<span style="color:#f59e42;font-weight:bold;">‚úÖ ${step.replace('<b>', '').replace('</b>', '')}</span>`;
          } else if (step.startsWith('<i>‡πÄ‡∏â‡∏•‡∏¢')) {
            coloredStep = `<span style="color:#22c55e;font-weight:bold;">‚ú® ${step.replace('<i>', '').replace('</i>', '')}</span>`;
          } else if (step.startsWith('<i>')) {
            coloredStep = `<span style="color:#64748b;">üí¨ ${step.replace('<i>', '').replace('</i>', '')}</span>`;
          } else if (step.startsWith('<span>Assume')) {
            coloredStep = `<span style="color:#f472b6;">üí° ${step.replace('<span>', '').replace('</span>', '')}</span>`;
          } else if (step.startsWith('1.') || step.startsWith('2.') || step.startsWith('3.') || step.startsWith('4.') || step.startsWith('5.')) {
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠
            const colors = ['#60a5fa', '#f59e42', '#22c55e', '#f472b6', '#a78bfa'];
            const color = colors[idx % colors.length];
            coloredStep = `<span style="color:${color};font-weight:500;">${step}</span>`;
          }
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏â‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏¢‡∏Å
          if (
            step.startsWith('<b>') ||
            step.startsWith('<i>') ||
            step.startsWith('<span') ||
            step.startsWith('<div') ||
            step.startsWith('<hr') ||
            step.startsWith('<u>')
          ) {
            if (hasList) {
              bubble.appendChild(list);
              hasList = false;
              list.innerHTML = '';
            }
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step';
            stepDiv.innerHTML = coloredStep;
            bubble.appendChild(stepDiv);
          } else {
            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö
            const li = document.createElement('li');
            li.className = 'step';
            li.innerHTML = coloredStep;
            list.appendChild(li);
            hasList = true;
          }
        });
        if (hasList) bubble.appendChild(list);
      } else {
        // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: sanitize ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å user/AI
        bubble.innerHTML = sanitizeHTML(text);
      }
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° favorite ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° user
      if (role === 'user') {
        const star = document.createElement('span');
        star.className = 'fav-star' + (isFav ? ' filled' : '');
        star.innerHTML = '&#9733;';
        star.title = isFav ? '‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡∏î' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡∏î';
        star.onclick = () => {
          if (isFav) {
            favorites = favorites.filter(f => f.text !== text);
          } else {
            favorites.push({ text });
          }
          saveFavorites();
          renderChat();
        };
        bubble.appendChild(star);
      }
      msgDiv.appendChild(bubble);
      chat.appendChild(msgDiv);
      chat.scrollTop = chat.scrollHeight;
      if (window.MathJax) MathJax.typesetPromise();
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ä‡∏ó (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô favorite ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
    function renderChat() {
      chat.innerHTML = '';
      // Quiz button
      addQuizButton();
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å history (user/ai ‡∏™‡∏•‡∏±‡∏ö)
      for (let i = 0; i < history.length; ++i) {
        const h = history[i];
        addMessage(h.role, h.text, h.steps, favorites.some(f => f.text === h.text));
      }
    }

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Quiz AI
    function addQuizButton() {
      if (document.getElementById('quiz-btn')) return;
      const btn = document.createElement('button');
      btn.textContent = 'üé≤ Quiz AI';
      btn.className = 'quiz-btn';
      btn.id = 'quiz-btn';
      btn.onclick = () => {
        addMessage('user', '‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢');
        aiRespond('quiz');
        history.push({ role: 'user', text: '‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢' });
        saveHistory();
        // ‡∏•‡∏ö addXP(5);
      };
      chat.appendChild(btn);
    }

    const GEMINI_API_KEY = 'AIzaSyA35LCCnO0RQm4zhBJrZZPZSRIJoQvd610'; // ‡πÉ‡∏™‡πà API KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ

    async function geminiAI(prompt) {
      if (!GEMINI_API_KEY || GEMINI_API_KEY === 'GEMINI_API_KEY') {
        return null;
      }
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
      const body = {
        contents: [{ parts: [{ text: prompt }] }]
      };
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          return data.candidates[0].content.parts.map(p => p.text).join('\n');
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á AI ‡∏ï‡∏≠‡∏ö (mockup)
    async function aiRespond(typeOrText) {
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gemini ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ü‡∏ô‡∏´‡∏ô‡∏∏‡πà‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤ "‡∏≠‡πâ‡∏ß‡∏ô"
      const AI_PERSONA_PROMPT = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ü‡∏ô‡∏´‡∏ô‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ü‡∏ô‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ
‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤ "‡∏≠‡πâ‡∏ß‡∏ô" ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ emoji ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô üíñ, üêª, üòò, ü•∞, üí°, ‚ú®, üéâ, üíï, ‡∏Ø‡∏•‡∏Ø
‡∏ñ‡πâ‡∏≤‡∏≠‡πâ‡∏ß‡∏ô‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤ "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞‡∏≠‡πâ‡∏ß‡∏ô" ‡∏û‡∏£‡πâ‡∏≠‡∏° emoji ‡∏£‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ü•∞üíñ
‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
`;

      if (typeOrText === 'quiz') {
        const steps = [
          '<b>Quiz:</b> ‡∏à‡∏á‡πÅ‡∏Å‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£ <span>2x + 5 = 11</span> üßÆ',
          '1. ‡∏¢‡πâ‡∏≤‡∏¢ 5 ‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏Ç‡πâ‡∏≤‡∏á: <span>2x = 11 - 5</span>',
          '2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: <span>2x = 6</span>',
          '3. ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 2: <span>x = 3</span>',
          '<i>‡πÄ‡∏â‡∏•‡∏¢: x = 3</i> <span style="color:#f472b6;">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞‡∏≠‡πâ‡∏ß‡∏ô ü•∞üíñ</span>'
        ];
        addMessage('ai', '', steps);
        history.push({ role: 'ai', text: '', steps });
        saveHistory();
        return;
      }
      const text = typeOrText.trim();
      if (GEMINI_API_KEY && GEMINI_API_KEY !== 'GEMINI_API_KEY') {
        addMessage('ai', '<i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡πâ‡∏ß‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞... üêªüí≠</i>');
        const aiMsgDiv = chat.lastChild;
        try {
          // ‡∏™‡πà‡∏á prompt ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ü‡∏ô‡∏´‡∏ô‡∏∏‡πà‡∏° + ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
          const aiText = await geminiAI(`${AI_PERSONA_PROMPT}\n\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${text}`);
          if (aiText && aiText.trim()) {
            // ‡πÉ‡∏™‡πà emoji ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
            let msg = aiText.trim();
            if (!/^[\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF]/.test(msg)) {
              msg = 'ü•∞ ' + msg;
            }
            if (!/[\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF]$/.test(msg)) {
              msg = msg + ' üíñ';
            }
            aiMsgDiv.querySelector('.bubble').innerHTML = sanitizeHTML(msg).replace(/\n/g, '<br>');
            if (window.MathJax) MathJax.typesetPromise();
            history.push({ role: 'ai', text: msg });
            saveHistory();
            return;
          }
          aiMsgDiv.querySelector('.bubble').innerHTML = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÑ‡∏î‡πâ üò¢';
          history.push({ role: 'ai', text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÑ‡∏î‡πâ üò¢' });
          saveHistory();
        } catch (e) {
          aiMsgDiv.querySelector('.bubble').innerHTML = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î üò¢';
          history.push({ role: 'ai', text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î üò¢' });
          saveHistory();
        }
        return;
      }
      // fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ API KEY
      let steps;
      if (/‡∏™‡∏°‡∏Å‡∏≤‡∏£|x|y|‡πÅ‡∏Å‡πâ|equation/i.test(text)) {
        steps = [
          '<b>‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏ß‡∏ô üßÆ</b>',
          '1. ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏Å‡∏≤‡∏£: <span>\\(x^2 + 3x = 0\\)</span>',
          '2. ‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö: <span>\\(x(x + 3) = 0\\)</span>',
          '3. ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô <span>\\(x = 0\\)</span> ‡∏´‡∏£‡∏∑‡∏≠ <span>\\(x = -3\\)</span>',
          '<b>‡∏ï‡∏≠‡∏ö:</b> <span>\\(x = 0, -3\\)</span> <span style="color:#f472b6;">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞‡∏≠‡πâ‡∏ß‡∏ô ü•∞üíñ</span>'
        ];
      } else if (/‡πÅ‡∏õ‡∏•|translate|assume/i.test(text)) {
        steps = [
          '<b>Assume</b> (v.) = ‡∏™‡∏°‡∏°‡∏ï‡∏¥, ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô üí°',
          '<i>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</i> <span>Assume that x = 2.</span> = ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ x = 2',
          '<span style="color:#f472b6;">‡∏≠‡πâ‡∏ß‡∏ô‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏µ‡∏Å‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üòòüíï</span>'
        ];
      } else if (/present perfect|‡πÅ‡∏Å‡∏£‡∏°‡∏°‡πà‡∏≤|grammar/i.test(text)) {
        steps = [
          '<b>Present Perfect</b> ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô üìö',
          '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: <span>have/has + V3</span>',
          '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <span>I have finished my homework.</span>',
          '<span style="color:#f472b6;">‡∏≠‡πâ‡∏ß‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‚ú®üíñ</span>'
        ];
      } else if (/‡∏™‡∏£‡∏∏‡∏õ|‡∏ö‡∏ó|laws|‡∏Ñ‡∏∑‡∏≠/i.test(text)) {
        steps = [
          '<b>Newton‚Äôs Laws</b> ‡∏Ñ‡∏∑‡∏≠ ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡∏ß‡∏ï‡∏±‡∏ô 3 ‡∏Ç‡πâ‡∏≠ üß≤',
          '1. ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏≥',
          '2. <span>F = ma</span> (‡πÅ‡∏£‡∏á = ‡∏°‡∏ß‡∏• √ó ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á)',
          '3. ‡∏ó‡∏∏‡∏Å‡πÅ‡∏£‡∏á‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°',
          '<span style="color:#f472b6;">‡∏≠‡πâ‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíï</span>'
        ];
      } else {
        steps = [
          '<span style="color:#f59e42">‡∏≠‡πâ‡∏ß‡∏ô‡∏à‡πã‡∏≤ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡∏†‡∏≤‡∏©‡∏≤, ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠ Quiz ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ü•∞‚ú®</span>'
        ];
      }
      addMessage('ai', '', steps);
      history.push({ role: 'ai', text: '', steps });
      saveHistory();
      if (window.MathJax) MathJax.typesetPromise();
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    function send() {
      const val = input.value.trim();
      if (!val) return;
      addMessage('user', val, null, favorites.some(f => f.text === val));
      history.push({ role: 'user', text: val });
      saveHistory();
      aiRespond(val);
      input.value = '';
      // ‡∏•‡∏ö addXP(2);
    }

    sendBtn.onclick = send;
    input.onkeydown = e => { if (e.key === 'Enter') send(); };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    window.onload = () => {
      if (history.length === 0) {
        addMessage('ai', 'üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ AI Tutor ‡∏ñ‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤, ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠ Quiz ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
        history.push({ role: 'ai', text: 'üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ AI Tutor ‡∏ñ‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤, ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠ Quiz ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢' });
        saveHistory();
      }
      renderChat();
    };

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô CSRF/Clickjacking (‡∏ù‡∏±‡πà‡∏á client)
    if (window.top !== window.self) {
      window.top.location = window.self.location;
    }
  </script>
</body>
</html>
